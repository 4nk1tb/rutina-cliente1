<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-180.png">
  <title>Rutina de Entrenamiento</title>
  <meta name="theme-color" content="#1A1A1C" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Estilos */
    :root {
      --bg: #1A1A1C; --bg-noise: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.05"/></svg>'); --elev: #28282A; --elev-2: #363638; --ink: #F5F5F7; --muted: #8A8A8E; --line: #3A3A3C; --brand: #FDB813; --ok: #34C759; --warn: #FF9500; --danger: #FF3B30; --radius-lg: 18px; --radius-md: 14px; --radius-sm: 10px; --shadow-lifted: 0 1px 2px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.3); --shadow-pressed: inset 0 2px 4px rgba(0,0,0,0.5); --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; --mono: "SF Mono", "Menlo", "Consolas", monospace; color-scheme: dark;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background-color: var(--bg); background-image: var(--bg-noise); color: var(--ink); font: 16px/1.6 var(--font); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem; }
    header { position: sticky; top: 0; z-index: 100; backdrop-filter: saturate(1.5) blur(20px); -webkit-backdrop-filter: saturate(1.5) blur(20px); background: rgba(26, 26, 28, 0.85); border-bottom: 1px solid var(--line); transition: box-shadow 0.3s ease; }
    header.scrolled { box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    .header-content { max-width: 1100px; margin: 0 auto; padding: 1rem; padding-top: calc(1rem + env(safe-area-inset-top)); }
    .title { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
    .logo { height: 75px; width: auto; }
    h1 { font-size: 1.25rem; margin: 0; font-weight: 700; }
    .subtitle { color: var(--muted); font-size: 0.9rem; margin: 0; }
    .day-tabs-container { margin-top: 1rem; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .day-tabs-container::-webkit-scrollbar { display: none; }
    .day-tabs { display: flex; gap: 0.75rem; padding-bottom: 0.5rem; }
    .tab { position: relative; overflow: hidden; flex: 0 0 auto; padding: 0.6rem 1rem; border-radius: var(--radius-md); background: var(--elev); border: 1px solid var(--line); text-align: center; color: var(--muted); font-weight: 600; cursor: pointer; user-select: none; transition: all 0.2s ease-out; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .tab:hover { transform: translateY(-2px); background: var(--elev-2); color: var(--ink); }
    .tab.active { background: var(--brand); color: #1A1A1C; border-color: transparent; font-weight: 700; }
    .tab.today { border-color: var(--brand); }
    .progress-bar { position: absolute; bottom: 0; left: 0; height: 3px; background-color: var(--brand); width: 0%; transition: width 0.4s ease-out; border-radius: 0 0 var(--radius-md) var(--radius-md); }
    .tab.active .progress-bar { background-color: rgba(26, 26, 28, 0.4); }
    .actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
    .btn { padding: 0.6rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--line); background: var(--elev); color: var(--ink); cursor: pointer; font-weight: 600; transition: all 0.2s ease-out; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.15); border-color: var(--muted); }
    .btn:active { transform: scale(0.96); transition-duration: 0.1s; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .card { background-image: linear-gradient(180deg, var(--elev), #242426); border: 1px solid var(--line); border-top-color: #48484A; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-lifted); opacity: 0; transform: translateY(20px) scale(0.98); animation: fadeIn 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0) scale(1); } }
    .day { display: none; }
    h2 { margin: 0 0 1.5rem; font-size: 1.3rem; font-weight: 700; }
    .exercise-note { font-size: 0.85rem; color: var(--muted); background-color: var(--elev-2); padding: 0.5rem 0.75rem; border-radius: var(--radius-sm); margin-top: 0.5rem; margin-bottom: 0; }
    .exercise { border: 1px solid var(--line); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem; background: var(--bg); }
    .exercise:last-child { margin-bottom: 0; }
    .head { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
    .name { font-weight: 700; font-size: 1.1rem; min-width: 0; }
    .meta { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .pill { padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 700; font-size: 0.75rem; color: var(--bg); }
    .p-rir { background: var(--warn); }
    .p-rep { background: var(--ok); }
    .p-rest { background: var(--muted); color: var(--ink); }
    .sets { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 0.75rem; }
    .set { aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--line); text-align: center; cursor: pointer; user-select: none; background-image: linear-gradient(180deg, var(--elev), #242426); font-weight: 600; transition: all 0.2s ease-out; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .set:hover { transform: translateY(-3px); }
    .set:active { transform: scale(0.95); transition-duration: 0.1s; }
    .set.done { background: var(--brand); color: #1A1A1C; border-color: transparent; box-shadow: var(--shadow-pressed); }
    .set small { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; transition: color 0.2s ease-out; }
    .set.done small { color: #1A1A1C; opacity: 0.8; }
    .row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; margin-top: 1rem; }
    .timer { position: relative; display: inline-flex; align-items: center; gap: 0.5rem; border: 1px solid var(--line); padding: 0.5rem 0.75rem; border-radius: var(--radius-sm); background: var(--elev); transition: all 0.3s ease; }
    .timer b { font-family: var(--mono); font-size: 1.2rem; transition: all 0.3s ease; }
    .sticky { position: sticky; top: 110px; }
    .panel { display: grid; gap: 1.5rem; }
    textarea { width: 100%; min-height: 120px; background: var(--bg); color: var(--ink); border: 1px solid var(--line); border-radius: var(--radius-md); padding: 1rem; font-family: var(--font); font-size: 1rem; }
    .footer { color: var(--muted); font-size: 0.8rem; opacity: .8; text-align: center; margin-top: 1rem; }
    #notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 0.8rem 1.2rem; border-radius: var(--radius-md); background-color: var(--elev-2); color: var(--ink); box-shadow: var(--shadow-lifted); transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); z-index: 200; text-align: center; display: flex; align-items: center; font-weight: 600; }
    #notification.show { bottom: 20px; transform: translateX(-50%) scale(1); opacity: 1; }
    #notification.success { background-color: var(--ok); color: var(--bg); }
    #notification.error { background-color: var(--danger); color: var(--ink); }

    .timer.running { border-color: var(--brand); }
    .timer::before { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: var(--radius-sm); background: radial-gradient(circle, rgba(253, 184, 19, 0.6) 0%, rgba(253, 184, 19, 0) 70%); opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; z-index: -1; pointer-events: none; }
    .timer.running::before { animation: pulse-glow 2s infinite alternate; }
    .timer.running button, .timer.running b { color: var(--brand); animation: pulse-glow-text 2s infinite alternate; }
    @keyframes pulse-glow {
        from { transform: scale(0.98); opacity: 0.7; }
        to { transform: scale(1.05); opacity: 1; }
    }
    @keyframes pulse-glow-text {
        from { text-shadow: 0 0 2px rgba(253, 184, 19, 0.7); }
        to { text-shadow: 0 0 10px rgba(253, 184, 19, 1); }
    }
    .pop-animation { animation: pop 0.3s ease-out; }
    @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }
    
    @media (min-width: 600px) {
      .wrap { padding: 2rem; }
      .header-content { padding: 1rem 2rem; padding-top: calc(1rem + env(safe-area-inset-top)); }
      .head { flex-direction: row; justify-content: space-between; align-items: center; gap: 1rem; }
      .meta { flex-wrap: nowrap; flex-shrink: 0; }
    }

    @media (min-width: 900px) { 
        .wrap { padding: 3rem 2rem; } 
        .grid { grid-template-columns: 1fr 0.6fr; } 
        .day-tabs-container { overflow-x: visible; } 
        .day-tabs { display: grid; grid-template-columns: repeat(7, 1fr); } 
        .quick-actions { display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem; } 
        .tab { white-space: normal; display: flex; align-items: center; justify-content: center; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="title">
      <img src="img/logo.png" alt="Logo" class="logo">
      <div>
        <h1>Rutina Personalizada</h1>
        <div class="subtitle">Plan de Fuerza + Hipertrofia</div>
      </div>
    </div>
    <div class="day-tabs-container">
      <div class="day-tabs" id="tabs"></div>
    </div>
    <div class="quick-actions">
        <div class="actions">
            <button class="btn" id="resetDay">↺ Reset día</button>
        </div>
    </div>
  </div>
</header>

<main class="wrap grid">
  <section id="workouts"></section>

  <aside class="panel sticky">
    <section class="card" style="animation-delay: 0.2s;">
        <h2>Progresión (6 semanas)</h2>
        <div class="row">
            <label style="color: var(--muted); font-weight: 500;">Semana actual:</label>
            <select id="week" style="background: var(--elev-2); color: var(--ink); border: 1px solid var(--line); border-radius: var(--radius-sm); padding: 0.5rem;">
                <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4 (Deload)</option> <option value="5">5</option> <option value="6">6</option>
            </select>
        </div>
        <p id="weekHint" style="margin-top: 1rem; color: var(--muted);"></p>
    </section>
    <section class="card" style="animation-delay: 0.3s;">
      <h2>Guía RIR</h2>
      <p style="color: var(--muted); margin: 0; font-size: 0.9rem;">
          <b>RIR 2:</b> Quedan ~2 reps. <b>RIR 1:</b> Última rep dura pero limpia. <b>RIR 0:</b> Fallo técnico. Excéntrica controlada.
      </p>
    </section>
    <section class="card" style="animation-delay: 0.4s;">
        <h2>Notas</h2>
        <textarea id="notes" placeholder="Sensaciones, cargas, RIR real, ajustes…"></textarea>
    </section>
    <section class="footer">
        <p>Todo se guarda en este dispositivo.</p>
        <div class="row" style="justify-content: center; margin-top: 0.5rem;">
            <button id="importBtn" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">📥 Importar JSON</button>
            <button id="exportBtn" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">📤 Exportar JSON</button>
            <input type="file" id="importFile" accept=".json,application/json" style="display:none;">
        </div>
    </section>
  </aside>
</main>

<div id="notification"></div>

<script>
(function(){

  const defaultRoutineData = {
    days: [
      {
        title: "Lunes • Push (Pecho)",
        exercises: [
          { id: "press_banca", name: "Press banca barra", sets: 3, reps: "5-8", rir: "RIR 2", rest: "2-3’", timer: 2.5 },
          { id: "press_inclinado_manc", name: "Press inclinado mancuernas", sets: 3, reps: "8-12", rir: "RIR 1-2", rest: "2’", timer: 2 },
          { id: "press_maquina", name: "Press máquina convergente", sets: 2, reps: "10-12", rir: "RIR 1", rest: "90”", timer: 1.5 },
          { id: "aperturas_cable", name: "Aperturas en cable", sets: 2, reps: "12-15", rir: "RIR 0-1", rest: "60-90”", timer: 1.5 },
          { id: "laterales_maint", name: "Elevación lateral (mantenimiento)", sets: 2, reps: "12-20", rir: "RIR 1", rest: "60-90”", timer: 1.5 },
          { id: "gemelos_pie_l", name: "Gemelos de pie", sets: 3, reps: "8-12", rir: "RIR 1", rest: "60-90”", timer: 1.5, note: "Pausa de 2 segundos abajo." }
        ]
      },
      {
        title: "Martes • Pull (Dorsal)",
        exercises: [
          { id: "dominadas", name: "Dominadas lastradas", sets: 4, reps: "6-8", rir: "RIR 1-2", rest: "2-3’", timer: 2.5 },
          { id: "jalon_neutro", name: "Jalón agarre neutro", sets: 3, reps: "8-12", rir: "RIR 1-2", rest: "2’", timer: 2 },
          { id: "pullover_polea", name: "Pullover en polea (estirado)", sets: 2, reps: "12-15", rir: "RIR 1", rest: "90”", timer: 1.5 },
          { id: "face_pull", name: "Face pull", sets: 2, reps: "15-20", rir: "RIR 0-1", rest: "60-90”", timer: 1.5 },
          { id: "curl_barra", name: "Curl barra", sets: 3, reps: "6-10", rir: "RIR 1-2", rest: "90”", timer: 1.5 },
          { id: "gemelos_sentado_m", name: "Gemelos sentado (sóleo)", sets: 4, reps: "12-20", rir: "RIR 1", rest: "60-90”", timer: 1.5, note: "Al final, estiramiento cargado 30 s." }
        ]
      },
      {
        title: "Miércoles • Pierna (Quads)",
        exercises: [
            { id: "prep_rodilla", name: "Preparación de Rodilla (6–8 min)", note: "TKE banda 2×15–20 + Isométricos extensión 2×20–30 s + Trineo atrás 2×20 m." },
            { id: "prensa_45_x", name: "Prensa 45°", sets: 4, reps: "10-12", rir: "RIR 1-2", rest: "2-3’", timer: 2.5, note: "Pies medios, ROM sin dolor." },
            { id: "extension_iso", name: "Extensión de rodilla", sets: 3, reps: "12-15", rir: "RIR 1", rest: "90”", timer: 1.5, note: "Isométrico 2-3 s en medio de la rep." },
            { id: "rdl_x", name: "Peso muerto rumano", sets: 3, reps: "6-10", rir: "RIR 2", rest: "2-3’", timer: 2.5 },
            { id: "hip_thrust_x", name: "Hip thrust barra", sets: 3, reps: "6-10", rir: "RIR 1-2", rest: "2’", timer: 2 },
            { id: "curl_femoral_x", name: "Curl femoral tumbado", sets: 3, reps: "8-12", rir: "RIR 1", rest: "90”", timer: 1.5 },
            { id: "gemelos_pie_x", name: "Gemelos de pie", sets: 3, reps: "8-12", rir: "RIR 1", rest: "60-90”", timer: 1.5 }
        ]
      },
      {
        title: "Jueves • Push (Delts)",
        exercises: [
            { id: "militar_manc", name: "Press militar sentado mancuernas", sets: 3, reps: "6-10", rir: "RIR 2", rest: "2’", timer: 2 },
            { id: "press_cerrado_smith", name: "Press banca agarre cerrado Smith", sets: 2, reps: "8-12", rir: "RIR 1-2", rest: "2’", timer: 2 },
            { id: "laterales_j", name: "Elevación lateral", sets: 2, reps: "12-20", rir: "RIR 1", rest: "60-90”", timer: 1.5 },
            { id: "peck_deck", name: "Peck-deck", sets: 2, reps: "10-15", rir: "RIR 1", rest: "90”", timer: 1.5 },
            { id: "triceps_ez", name: "Extensión tríceps barra EZ", sets: 2, reps: "10-12", rir: "RIR 1", rest: "60-90”", timer: 1.5 },
            { id: "gemelos_sentado_j", name: "Gemelos sentado", sets: 3, reps: "12-20", rir: "RIR 1", rest: "60-90”", timer: 1.5 }
        ]
      },
      {
        title: "Viernes • Pull (Espesor)",
        exercises: [
            { id: "remo_t", name: "Remo T apoyado pecho", sets: 4, reps: "6-10", rir: "RIR 1-2", rest: "2-3’", timer: 2.5 },
            { id: "remo_cable_neutro", name: "Remo cable neutro", sets: 3, reps: "8-12", rir: "RIR 1-2", rest: "2’", timer: 2 },
            { id: "reverse_fly", name: "Reverse fly", sets: 2, reps: "15-20", rir: "RIR 0-1", rest: "60-90”", timer: 1.5 },
            { id: "curl_martillo", name: "Curl martillo", sets: 2, reps: "8-12", rir: "RIR 1", rest: "90”", timer: 1.5 },
            { id: "curl_inclinado", name: "Curl inclinado (estirado)", sets: 2, reps: "10-15", rir: "RIR 1", rest: "90”", timer: 1.5 }
        ]
      },
      {
        title: "Sábado • Pierna (Full)",
        exercises: [
            { id: "hack_squat", name: "Hack squat / Pendulum", sets: 4, reps: "8-12", rir: "RIR 1-2", rest: "2-3’", timer: 2.5, note: "ROM Cómodo. Si duele: step-up bajo o belt squat." },
            { id: "prensa_pies_bajos", name: "Prensa 45° pies bajos", sets: 3, reps: "10-15", rir: "RIR 1-2", rest: "2-3’", timer: 2.5, note: "Hacer si se tolera (más quad)." },
            { id: "extension_1.5", name: "Extensión 1.5 reps", sets: 3, reps: "12-15", rir: "RIR 1", rest: "90”", timer: 1.5, note: "Recorrido: mitad → completo → mitad." },
            { id: "curl_femoral_sentado", name: "Curl femoral sentado", sets: 3, reps: "10-15", rir: "RIR 1", rest: "90”", timer: 1.5 },
            { id: "gemelos_pie_s", name: "Gemelos de pie", sets: 4, reps: "8-12", rir: "RIR 1", rest: "60-90”", timer: 1.5 }
        ]
      },
      {
        title: "Domingo • Descanso",
        exercises: [
            { id: "descanso", name: "Descanso Activo", note: "Paseo ligero, movilidad suave. El objetivo es recuperar bien para la próxima semana." }
        ]
      }
    ]
  };

  const $ = (q, el = document) => el.querySelector(q);
  const $$ = (q, el = document) => [...el.querySelectorAll(q)];
  const stateKey = 'rutina-fuerza-elegante-v5-optimized';
  let state = JSON.parse(localStorage.getItem(stateKey) || '{}');
  const originalTitle = document.title;
  const today = new Date();
  const dow = (today.getDay() + 6) % 7;
  const tabsContainer = $('#tabs');
  const workoutsContainer = $('#workouts');
  const weekSel = $('#week');
  const weekHint = $('#weekHint');
  const notes = $('#notes');
  let routineData;
  const timers = new Map();

  function renderRoutine(data) {
    tabsContainer.innerHTML = '';
    workoutsContainer.innerHTML = '';

    data.days.forEach((day, dayIndex) => {
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.dataset.day = dayIndex;
      tab.innerHTML = `<span>${day.title}</span><div class="progress-bar"></div>`;
      tabsContainer.appendChild(tab);

      const dayCard = document.createElement('article');
      dayCard.className = 'card day';
      dayCard.dataset.day = dayIndex;
      dayCard.style.animationDelay = `${0.1 + dayIndex * 0.05}s`;
      let exercisesHTML = `<h2>${day.title.replace(/•/g, '–')}</h2>`;

      day.exercises.forEach(ex => {
        const exId = `${dayIndex}:${ex.id}`;
        if (!ex.sets) {
            exercisesHTML += `<div class="exercise" data-ex-id="${exId}"><div class="head"><div class="name">${ex.name}</div></div>${ex.note ? `<p class="exercise-note" style="margin-top:0;">${ex.note}</p>` : ''}</div>`;
            return;
        }

        exercisesHTML += `
          <div class="exercise" data-ex-id="${exId}">
            <div class="head">
                <div class="name">${ex.name}</div>
                <div class="meta">
                    <span class="pill p-rep">${ex.sets}×${ex.reps}</span>
                    <span class="pill p-rir">${ex.rir}</span>
                    <span class="pill p-rest">${ex.rest}</span>
                </div>
            </div>
            <div class="sets" data-default="${ex.sets}"></div>
            ${ex.note ? `<p class="exercise-note">${ex.note}</p>` : ''}
            <div class="row">
                <div class="timer" data-min="${ex.timer || 1.5}"><b>00:00</b><button class="btn btn-mini" data-action="toggle-timer">▶︎</button></div> 
                <button class="btn" data-action="add-set">+ Serie</button> 
                <button class="btn delset" data-action="del-set">– Serie</button>
            </div>
          </div>`;
      });
      dayCard.innerHTML = exercisesHTML;
      workoutsContainer.appendChild(dayCard);
    });
  }

  function initializeTimers() {
      $$('.timer').forEach(timerEl => {
          const exId = timerEl.closest('.exercise').dataset.exId;
          const min = parseFloat(timerEl.dataset.min || '2');
          const display = $('b', timerEl);
          const btn = $('button', timerEl);
          let running = false, left = 0, iv = null;

          const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;
          const start = () => { if (running) return; left = Math.round(min * 60); running = true; btn.textContent = '⏸'; timerEl.classList.add('running'); tick(); iv = setInterval(tick, 1000); };
          const stop = () => { running = false; clearInterval(iv); btn.textContent = '▶︎'; timerEl.classList.remove('running'); document.title = originalTitle; display.textContent = fmt(min * 60); };
          const tick = () => { display.textContent = fmt(left); document.title = `${fmt(left)} | Descanso`; if (left-- <= 0) stop(); };
          
          display.textContent = fmt(min * 60);
          timers.set(exId, { start, stop, isRunning: () => running });
      });
  }
  
  function renderSets(setsWrap, arr, id) {
    setsWrap.innerHTML = '';
    arr.forEach((val, i) => {
        const b = document.createElement('button');
        b.className = 'set' + (val ? ' done' : '');
        b.dataset.action = 'toggle-set';
        b.dataset.index = i;
        b.innerHTML = `S${i+1}<small>${val?'OK':'-'}</small>`;
        setsWrap.appendChild(b);
    });
    updateAllProgressBars();
  }

  function handleWorkoutClick(event) {
    const target = event.target;
    const action = target.dataset.action || target.closest('[data-action]')?.dataset.action;
    if (!action) return;

    const exerciseEl = target.closest('.exercise');
    if (!exerciseEl) return;
    const exId = exerciseEl.dataset.exId;
    const setsWrap = $('.sets', exerciseEl);

    switch (action) {
        case 'toggle-set': {
            const setIndex = parseInt(target.dataset.index, 10);
            const now = state.sets[exId];
            const isCompletingSet = !now[setIndex];
            now[setIndex] = isCompletingSet;
            
            saveSets(exId, now);
            renderSets(setsWrap, now, exId);
            
            if (isCompletingSet) {
                const button = $(`.set[data-index='${setIndex}']`, setsWrap);
                button.classList.add('pop-animation');
                button.addEventListener('animationend', () => button.classList.remove('pop-animation'), { once: true });
                timers.get(exId)?.start();
            }
            break;
        }
        case 'toggle-timer': {
            const timer = timers.get(exId);
            if (timer) timer.isRunning() ? timer.stop() : timer.start();
            break;
        }
        case 'add-set': {
            const now = state.sets[exId];
            now.push(false);
            saveSets(exId, now);
            renderSets(setsWrap, now, exId);
            break;
        }
        case 'del-set': {
            const now = state.sets[exId];
            if (now.length > 1) {
                now.pop();
                saveSets(exId, now);
                renderSets(setsWrap, now, exId);
            }
            break;
        }
    }
  }
  
  function saveSets(id, arr) {
    state.sets = state.sets || {};
    state.sets[id] = arr;
    save();
    const delBtn = $(`[data-ex-id="${id}"] .delset`);
    if(delBtn) delBtn.classList.toggle('ghost', arr.length <= 1);
  }

  function activateTab(idx) {
    $$('.tab', tabsContainer).forEach(t => t.classList.remove('active'));
    $(`.tab[data-day="${idx}"]`, tabsContainer)?.classList.add('active');
    $$('.day').forEach(c => c.style.display = (+c.dataset.day === idx) ? 'block' : 'none');
    state.lastOpenedDay = idx;
    save();
  }

  function resetCurrentDay() {
    const d = currentDay();
    const card = $(`.day[data-day="${d}"]`);
    if (card) {
      $$('.exercise', card).forEach(ex => {
        const setsWrap = $('.sets', ex);
        if (!setsWrap) return;
        const exId = ex.dataset.exId;
        const def = +setsWrap.dataset.default || 3;
        const arr = Array(def).fill(false);
        saveSets(exId, arr);
        renderSets(setsWrap, arr, exId);
      });
    }
  }

  function updateAllProgressBars() {
    routineData.days.forEach((day, dayIndex) => {
        const tab = $(`.tab[data-day="${dayIndex}"]`);
        if (!tab) return;
        let totalSets = 0, doneSets = 0;
        day.exercises.forEach(ex => {
            if (ex.sets) {
                const exId = `${dayIndex}:${ex.id}`;
                const setsArray = state.sets?.[exId];
                if (setsArray) {
                    totalSets += setsArray.length;
                    doneSets += setsArray.filter(d => d).length;
                } else {
                    totalSets += ex.sets;
                }
            }
        });
        const percentage = totalSets > 0 ? (doneSets / totalSets) * 100 : 0;
        const progressBar = $('.progress-bar', tab);
        if (progressBar) progressBar.style.width = `${percentage}%`;
    });
  }

  function init() {
    routineData = loadRoutineData();
    renderRoutine(routineData);
    
    // Initialize state for exercises if not present
    state.sets = state.sets || {};
    routineData.days.forEach((day, dayIndex) => {
        day.exercises.forEach(ex => {
            if (ex.sets) {
                const exId = `${dayIndex}:${ex.id}`;
                if (!state.sets[exId]) {
                    state.sets[exId] = Array(ex.sets).fill(false);
                }
                const setsWrap = $(`[data-ex-id="${exId}"] .sets`);
                if(setsWrap) renderSets(setsWrap, state.sets[exId], exId);
            }
        });
    });
    
    initializeTimers();
    workoutsContainer.addEventListener('click', handleWorkoutClick);
    tabsContainer.addEventListener('click', e => {
        const tab = e.target.closest('.tab');
        if (tab) activateTab(+tab.dataset.day);
    });

    $('#resetDay').addEventListener('click', resetCurrentDay);
    if (state.week) weekSel.value = state.week;
    applyWeekHint();
    notes.value = state.notes || '';
    notes.addEventListener('input', () => { state.notes = notes.value; save(); });

    const initialDay = state.lastOpenedDay !== undefined ? state.lastOpenedDay : dow;
    activateTab(initialDay);
    $$('.tab', tabsContainer).forEach(t => {
      if (t.dataset.day == dow) t.classList.add('today');
    });
    updateAllProgressBars();
    
    const header = $('header');
    window.addEventListener('scroll', () => {
        header.classList.toggle('scrolled', window.scrollY > 10);
    });
  }

  function loadRoutineData() {
      const savedRoutine = localStorage.getItem('customRoutineData');
      if (savedRoutine) {
          try { return JSON.parse(savedRoutine); } 
          catch (e) { console.error("Error al cargar rutina guardada, usando la de por defecto.", e); return defaultRoutineData; }
      }
      return defaultRoutineData;
  }
  
  function save() { localStorage.setItem(stateKey, JSON.stringify(state)); }
  function currentDay() { const t = $('.tab.active', tabsContainer); return t ? +t.dataset.day : 0; }
  
  let notificationTimeout;
  function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      if (!notification) return;
      clearTimeout(notificationTimeout);
      const icon = type === 'success' ? '✅' : '❌';
      notification.innerHTML = `<span style="margin-right: 0.5rem;">${icon}</span> ${message}`;
      notification.className = type;
      setTimeout(() => { notification.classList.add('show'); }, 10);
      notificationTimeout = setTimeout(() => { notification.classList.remove('show'); }, 3000);
  }

  function applyWeekHint() {
    const w = weekSel.value; weekHint.style.color = 'var(--muted)'; weekHint.textContent = '';
    if(w === '1'){ weekHint.textContent='Sem 1: Compuestos @RIR2–3; Accesorios @RIR1–2.'; } 
    else if(w === '2' || w === '3'){ weekHint.textContent='Sem 2–3: Compuestos @RIR1–2; Accesorios @RIR0–1.'; weekHint.style.color='var(--warn)'; } 
    else if(w === '4'){ weekHint.textContent='DELOAD: −40–50% series, +1–2 RIR.'; weekHint.style.color='var(--danger)'; } 
    else if(w === '5' || w === '6'){ weekHint.textContent='Sem 5–6: Repite Sem 2-3 y añade +1 serie a quads o lats.'; weekHint.style.color='var(--ok)'; }
  }

  function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
          try {
              const importedData = JSON.parse(e.target.result);
              if (!importedData.days || !Array.isArray(importedData.days)) { throw new Error("Formato de rutina inválido."); }
              localStorage.setItem('customRoutineData', JSON.stringify(importedData));
              localStorage.removeItem(stateKey); 
              state = {};
              init();
              showNotification('Rutina importada con éxito.');
          } catch (error) {
              console.error("Fallo al importar la rutina:", error);
              showNotification('Error: El archivo JSON no es válido.', 'error');
          }
      };
      reader.readAsText(file);
      event.target.value = '';
  }

  function handleExport() {
      try {
          const jsonString = JSON.stringify(routineData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'mi-rutina.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showNotification('Rutina exportada.');
      } catch (error) {
          console.error("Fallo al exportar la rutina:", error);
          showNotification('Error al exportar.', 'error');
      }
  }

  $('#importBtn').addEventListener('click', () => $('#importFile').click());
  $('#importFile').addEventListener('change', handleImport);
  $('#exportBtn').addEventListener('click', handleExport);

  init();
  
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker: Registrado'))
        .catch(err => console.log(`Service Worker: Error: ${err}`));
    });
  }
})();
</script>
</body>
</html>

