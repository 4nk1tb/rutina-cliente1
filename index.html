<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-180.png">
  <title>Rutina de Entrenamiento</title>
  <meta name="theme-color" content="#1A1A1C" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Estilos */
    :root {
      --bg: #1A1A1C; --bg-noise: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.05"/></svg>'); --elev: #28282A; --elev-2: #363638; --ink: #F5F5F7; --muted: #8A8A8E; --line: #3A3A3C; --brand: #FDB813; --ok: #34C759; --warn: #FF9500; --danger: #FF3B30; --radius-lg: 18px; --radius-md: 14px; --radius-sm: 10px; --shadow-lifted: 0 1px 2px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.3); --shadow-pressed: inset 0 2px 4px rgba(0,0,0,0.5); --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; --mono: "SF Mono", "Menlo", "Consolas", monospace; color-scheme: dark;
    }
    * { box-sizing: border-box; }
    html { height: 100%; }
    body { min-height: 100%; margin: 0; background-color: var(--bg); background-image: var(--bg-noise); color: var(--ink); font: 16px/1.6 var(--font); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; padding-bottom: 100px; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem; }
    header { position: sticky; top: 0; z-index: 100; backdrop-filter: saturate(1.5) blur(20px); -webkit-backdrop-filter: saturate(1.5) blur(20px); background: rgba(26, 26, 28, 0.85); border-bottom: 1px solid var(--line); transition: box-shadow 0.3s ease; }
    header.scrolled { box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    .header-content { max-width: 1100px; margin: 0 auto; padding: 1rem; padding-top: calc(1rem + env(safe-area-inset-top)); }
    .title { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; cursor: pointer; }
    .logo { height: 75px; width: auto; }
    h1 { font-size: 1.25rem; margin: 0; font-weight: 700; }
    .subtitle { color: var(--muted); font-size: 0.9rem; margin: 0; }
    .day-tabs-container { margin-top: 1rem; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .day-tabs-container::-webkit-scrollbar { display: none; }
    .day-tabs { display: flex; gap: 0.75rem; padding-bottom: 0.5rem; }
    .tab { position: relative; overflow: hidden; flex: 0 0 auto; padding: 0.6rem 1rem; border-radius: var(--radius-md); background: var(--elev); border: 1px solid var(--line); text-align: center; color: var(--muted); font-weight: 600; cursor: pointer; user-select: none; transition: all 0.2s ease-out; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .tab:hover { transform: translateY(-2px); background: var(--elev-2); color: var(--ink); }
    .tab.active { background: var(--brand); color: #1A1A1C; border-color: transparent; font-weight: 700; }
    .progress-bar { position: absolute; bottom: 0; left: 0; height: 3px; background-color: var(--brand); width: 0%; transition: width 0.4s ease-out; border-radius: 0 0 var(--radius-md) var(--radius-md); }
    .tab.active .progress-bar { background-color: rgba(26, 26, 28, 0.4); }
    .actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
    .btn { padding: 0.6rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--line); background: var(--elev); color: var(--ink); cursor: pointer; font-weight: 600; transition: all 0.2s ease-out; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.15); border-color: var(--muted); }
    .btn:active { transform: scale(0.96); transition-duration: 0.1s; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .card { background-image: linear-gradient(180deg, var(--elev), #242426); border: 1px solid var(--line); border-top-color: #48484A; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-lifted); opacity: 0; transform: translateY(20px) scale(0.98); animation: fadeIn 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0) scale(1); } }
    .day { display: none; }
    h2 { margin: 0 0 1.5rem; font-size: 1.3rem; font-weight: 700; }
    .exercise-note { font-size: 0.85rem; color: var(--muted); background-color: var(--elev-2); padding: 0.5rem 0.75rem; border-radius: var(--radius-sm); margin-top: 0.5rem; margin-bottom: 0; }
    .exercise { border: 1px solid var(--line); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem; background: var(--bg); }
    .exercise:last-child { margin-bottom: 0; }
    .head { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
    .name { font-weight: 700; font-size: 1.1rem; min-width: 0; }
    .meta { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .pill { padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 700; font-size: 0.75rem; color: var(--bg); }
    .p-rir { background: var(--warn); }
    .p-rep { background: var(--ok); }
    .p-rest { background: var(--muted); color: var(--ink); }
    .sets { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 0.75rem; }
    .set { aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.5rem; border-radius: var(--radius-sm); border: 1px solid var(--line); text-align: center; cursor: pointer; user-select: none; background-image: linear-gradient(180deg, var(--elev), #242426); font-weight: 600; transition: all 0.2s ease-out; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .set:hover { transform: translateY(-3px); }
    .set:active { transform: scale(0.95); transition-duration: 0.1s; }
    .set.done { background: var(--brand); color: #1A1A1C; border-color: transparent; box-shadow: var(--shadow-pressed); }
    .set small { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; transition: color 0.2s ease-out; }
    .set.done small { color: #1A1A1C; opacity: 0.8; }
    .row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; margin-top: 1rem; }
    .timer { position: relative; display: inline-flex; align-items: center; gap: 0.5rem; border: 1px solid var(--line); padding: 0.5rem 0.75rem; border-radius: var(--radius-sm); background: var(--elev); transition: all 0.3s ease; }
    .timer b { font-family: var(--mono); font-size: 1.2rem; transition: all 0.3s ease; }
    .sticky { position: sticky; top: 110px; }
    .panel { display: grid; gap: 1.5rem; }
    textarea { width: 100%; min-height: 120px; background: var(--bg); color: var(--ink); border: 1px solid var(--line); border-radius: var(--radius-md); padding: 1rem; font-family: var(--font); font-size: 1rem; }
    .footer { color: var(--muted); font-size: 0.8rem; opacity: .8; text-align: center; margin-top: 1rem; }
    #notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 0.8rem 1.2rem; border-radius: var(--radius-md); background-color: var(--elev-2); color: var(--ink); box-shadow: var(--shadow-lifted); transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); z-index: 200; text-align: center; display: flex; align-items: center; font-weight: 600; }
    #notification.show { bottom: 20px; transform: translateX(-50%) scale(1); opacity: 1; }
    #notification.success { background-color: var(--ok); color: var(--bg); }
    #notification.error { background-color: var(--danger); color: var(--ink); }

    .timer.running { border-color: var(--brand); }
    .timer::before { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: var(--radius-sm); background: radial-gradient(circle, rgba(253, 184, 19, 0.6) 0%, rgba(253, 184, 19, 0) 70%); opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; z-index: -1; pointer-events: none; }
    .timer.running::before { animation: pulse-glow 2s infinite alternate; }
    .timer.running button, .timer.running b { color: var(--brand); animation: pulse-glow-text 2s infinite alternate; }
    @keyframes pulse-glow {
        from { transform: scale(0.98); opacity: 0.7; }
        to { transform: scale(1.05); opacity: 1; }
    }
    @keyframes pulse-glow-text {
        from { text-shadow: 0 0 2px rgba(253, 184, 19, 0.7); }
        to { text-shadow: 0 0 10px rgba(253, 184, 19, 1); }
    }
    .pop-animation { animation: pop 0.3s ease-out; }
    @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }
    
    /* --- Estilos Nueva P√°gina de Progreso --- */
    .app-page { display: none; }
    .app-page.active { display: block; }
    #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(60px + env(safe-area-inset-bottom)); background: rgba(26, 26, 28, 0.85); backdrop-filter: saturate(1.5) blur(20px); -webkit-backdrop-filter: saturate(1.5) blur(20px); border-top: 1px solid var(--line); display: flex; justify-content: space-around; align-items: flex-start; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
    .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; color: var(--muted); font-family: var(--font); font-size: 0.7rem; font-weight: 600; padding-top: 8px; flex-grow: 1; cursor: pointer; transition: color 0.2s ease; }
    .nav-btn svg { width: 24px; height: 24px; margin-bottom: 2px; }
    .nav-btn.active { color: var(--brand); }
    .progress-list .exercise-item { background: var(--elev); border: 1px solid var(--line); border-radius: var(--radius-md); margin-bottom: 0.75rem; padding: 1rem; cursor: pointer; transition: all 0.2s ease; }
    .progress-list .exercise-item:hover { transform: translateY(-2px); border-color: var(--muted); }
    .progress-chart-container { margin-top: 2rem; }
    #chart-svg { width: 100%; height: auto; font-family: var(--font); }
    #chart-svg .grid-line { stroke: var(--line); stroke-dasharray: 2, 3; }
    #chart-svg .axis-label-y { fill: var(--muted); font-size: 10px; }
    #chart-svg .axis-label-x { fill: var(--muted); font-size: 9px; }
    #chart-svg .data-label { fill: var(--ink); font-size: 10px; font-weight: 600; }
    #chart-svg .data-line { stroke: var(--brand); stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; animation: draw-line 1s ease-out forwards; }
    #chart-svg .data-point { fill: var(--brand); r: 4; transition: r 0.2s ease; }
    #chart-svg .data-point:hover { r: 6; }
    @keyframes draw-line { from { stroke-dasharray: 1000; stroke-dashoffset: 1000; } to { stroke-dasharray: 1000; stroke-dashoffset: 0; } }
    #progress-detail-view h3 { margin-top: 0; }
    #progress-history-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    #progress-history-table th, #progress-history-table td { text-align: left; padding: 0.5rem; border-bottom: 1px solid var(--line); }
    #progress-history-table th { font-size: 0.8rem; color: var(--muted); }
    #no-progress-data { text-align: center; color: var(--muted); padding: 3rem 1rem; }
    #progressBtnDesktop { display: none; }
    
    /* --- Estilos Modal --- */
    #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    #modal-overlay.visible { opacity: 1; pointer-events: all; }
    #modal-content { background: var(--elev); padding: 1.5rem; border-radius: var(--radius-lg); width: 90%; max-width: 320px; transform: scale(0.95); transition: transform 0.3s ease; }
    #modal-overlay.visible #modal-content { transform: scale(1); }
    #modal-content h3 { margin-top: 0; }
    .modal-input { width: 100%; background: var(--bg); color: var(--ink); border: 1px solid var(--line); border-radius: var(--radius-sm); padding: 0.75rem; font-family: var(--font); font-size: 1rem; margin-bottom: 1rem; }
    
    @media (min-width: 600px) {
      .wrap { padding: 2rem; }
      .header-content { padding: 1rem 2rem; padding-top: calc(1rem + env(safe-area-inset-top)); }
      .head { flex-direction: row; justify-content: space-between; align-items: center; gap: 1rem; }
      .meta { flex-wrap: nowrap; flex-shrink: 0; }
    }

    @media (min-width: 900px) { 
        .wrap { padding: 3rem 2rem; } 
        .grid { grid-template-columns: 1fr 0.6fr; } 
        .day-tabs { display: grid; grid-template-columns: repeat(7, 1fr); } 
        .tab { white-space: normal; display: flex; align-items: center; justify-content: center; }
        body { padding-bottom: 0; } 
        #bottom-nav { display: none; }
        #progressBtnDesktop { display: inline-flex; }

        /* --- NUEVO: Estilos para el header en PC --- */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }
        .title {
            margin-bottom: 0;
            flex-shrink: 0; /* Evita que el t√≠tulo se encoja */
        }
        .day-tabs-container {
            margin-top: 0;
            flex-grow: 1; /* Permite que las pesta√±as ocupen el espacio disponible */
            overflow-x: visible;
        }
        .quick-actions {
            margin-top: 0;
            flex-shrink: 0; /* Evita que los botones se encojan */
        }
    }
  </style>
</head>
<body>

<header>
    <div class="header-content">
      <div class="title">
        <img src="img/logo.png" alt="Logo" class="logo">
        <div>
          <h1 id="header-title">Rutina Personalizada</h1>
          <div id="header-subtitle" class="subtitle">Plan de Fuerza + Hipertrofia</div>
        </div>
      </div>
      <div id="header-tabs" class="day-tabs-container">
        <div class="day-tabs" id="tabs"></div>
      </div>
      <div id="header-actions" class="quick-actions">
          <div class="actions">
              <button class="btn" id="progressBtnDesktop">üìä Progreso</button>
              <button class="btn" id="resetDay">‚Ü∫ Reset d√≠a</button>
          </div>
      </div>
    </div>
</header>

<div id="routine-page" class="app-page active">
    <main class="wrap grid">
      <section id="workouts"></section>
      <aside class="panel sticky">
        <section class="card" style="animation-delay: 0.2s;">
            <h2>Progresi√≥n (6 semanas)</h2>
            <div class="row">
                <label style="color: var(--muted); font-weight: 500;">Semana actual:</label>
                <select id="week" style="background: var(--elev-2); color: var(--ink); border: 1px solid var(--line); border-radius: var(--radius-sm); padding: 0.5rem;">
                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4 (Deload)</option> <option value="5">5</option> <option value="6">6</option>
                </select>
            </div>
            <p id="weekHint" style="margin-top: 1rem; color: var(--muted);"></p>
        </section>
        <section class="card" style="animation-delay: 0.3s;">
          <h2>Gu√≠a RIR</h2>
          <p style="color: var(--muted); margin: 0; font-size: 0.9rem;">
              <b>RIR 2:</b> Quedan ~2 reps. <b>RIR 1:</b> √öltima rep dura pero limpia. <b>RIR 0:</b> Fallo t√©cnico. Exc√©ntrica controlada.
          </p>
        </section>
        <section class="card" style="animation-delay: 0.4s;">
            <h2>Notas</h2>
            <textarea id="notes" placeholder="Sensaciones, cargas, RIR real, ajustes‚Ä¶"></textarea>
        </section>
        <section class="footer">
            <p>Todo se guarda en este dispositivo.</p>
            <div class="row" style="justify-content: center; margin-top: 0.5rem;">
                <button id="importBtn" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">üì• Importar JSON</button>
                <button id="exportBtn" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">üì§ Exportar JSON</button>
                <input type="file" id="importFile" accept=".json,application/json" style="display:none;">
            </div>
        </section>
      </aside>
    </main>
</div>

<div id="progress-page" class="app-page">
    <div id="progress-content" class="wrap">
        <!-- El contenido de la p√°gina de progreso se generar√° aqu√≠ -->
    </div>
</div>

<div id="modal-overlay">
    <div id="modal-content">
        <h3 id="modal-title">Registrar Carga</h3>
        <input type="number" id="modal-weight-input" class="modal-input" placeholder="Peso (kg)">
        <div class="row" style="justify-content: flex-end;">
            <button id="modal-cancel" class="btn">Cancelar</button>
            <button id="modal-save" class="btn" style="background: var(--brand); color: var(--bg);">Guardar</button>
        </div>
    </div>
</div>

<nav id="bottom-nav">
    <button class="nav-btn active" data-page="routine-page">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2.236a1 1 0 0 1 2 0v5.326a1 1 0 0 1-2 0V2.236zM3.414 4.828a1 1 0 1 1 1.414-1.414l3.768 3.768a1 1 0 0 1-1.414 1.414L3.414 4.828zM15.39 8.61a1 1 0 0 1 1.414-1.414l3.768 3.768a1 1 0 0 1-1.414 1.414l-3.768-3.768zM2 13a1 1 0 0 1 1-1h5.326a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1zm14.674-1a1 1 0 1 1 0 2H21a1 1 0 1 1 0-2h-4.326zM8.61 15.39a1 1 0 1 1-1.414 1.414l-3.768-3.768a1 1 0 1 1 1.414-1.414l3.768 3.768zm7.362 5.182a1 1 0 0 1-1.414 1.414l-3.768-3.768a1 1 0 0 1 1.414-1.414l3.768 3.768zM12 21.764a1 1 0 0 1 0-2v5.326a1 1 0 1 1 0-2v-3.326z"/></svg>
        <span>Rutina</span>
    </button>
    <button class="nav-btn" data-page="progress-page">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12h2v9H3v-9zm16 0h2v9h-2v-9zm-8-5h2v14h-2V7z"/></svg>
        <span>Progreso</span>
    </button>
</nav>


<div id="notification"></div>

<script>
(function(){

  const defaultRoutineData = {
    days: [
      {
        title: "Lunes ‚Ä¢ Push (Pecho)",
        exercises: [
          { id: "press_banca", name: "Press banca barra", sets: 3, reps: "5-8", rir: "RIR 2", rest: "2-3‚Äô", timer: 2.5 },
          { id: "press_inclinado_manc", name: "Press inclinado mancuernas", sets: 3, reps: "8-12", rir: "RIR 1-2", rest: "2‚Äô", timer: 2 },
          { id: "press_maquina", name: "Press m√°quina convergente", sets: 2, reps: "10-12", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 },
          { id: "aperturas_cable", name: "Aperturas en cable", sets: 2, reps: "12-15", rir: "RIR 0-1", rest: "60-90‚Äù", timer: 1.5 },
          { id: "laterales_maint", name: "Elevaci√≥n lateral (mantenimiento)", sets: 2, reps: "12-20", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5 },
          { id: "gemelos_pie_l", name: "Gemelos de pie", sets: 3, reps: "8-12", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5, note: "Pausa de 2 segundos abajo." }
        ]
      },
      {
        title: "Martes ‚Ä¢ Pull (Dorsal)",
        exercises: [
          { id: "dominadas", name: "Dominadas lastradas", sets: 4, reps: "6-8", rir: "RIR 1-2", rest: "2-3‚Äô", timer: 2.5 },
          { id: "jalon_neutro", name: "Jal√≥n agarre neutro", sets: 3, reps: "8-12", rir: "RIR 1-2", rest: "2‚Äô", timer: 2 },
          { id: "pullover_polea", name: "Pullover en polea (estirado)", sets: 2, reps: "12-15", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 },
          { id: "face_pull", name: "Face pull", sets: 2, reps: "15-20", rir: "RIR 0-1", rest: "60-90‚Äù", timer: 1.5 },
          { id: "curl_barra", name: "Curl barra", sets: 3, reps: "6-10", rir: "RIR 1-2", rest: "90‚Äù", timer: 1.5 },
          { id: "gemelos_sentado_m", name: "Gemelos sentado (s√≥leo)", sets: 4, reps: "12-20", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5, note: "Al final, estiramiento cargado 30 s." }
        ]
      },
      {
        title: "Mi√©rcoles ‚Ä¢ Pierna (Quads)",
        exercises: [
            { id: "prep_rodilla", name: "Preparaci√≥n de Rodilla (6‚Äì8 min)", note: "TKE banda 2√ó15‚Äì20 + Isom√©tricos extensi√≥n 2√ó20‚Äì30 s + Trineo atr√°s 2√ó20 m." },
            { id: "prensa_45_x", name: "Prensa 45¬∞", sets: 4, reps: "10-12", rir: "RIR 1-2", rest: "2-3‚Äô", timer: 2.5, note: "Pies medios, ROM sin dolor." },
            { id: "extension_iso", name: "Extensi√≥n de rodilla", sets: 3, reps: "12-15", rir: "RIR 1", rest: "90‚Äù", timer: 1.5, note: "Isom√©trico 2-3 s en medio de la rep." },
            { id: "rdl_x", name: "Peso muerto rumano", sets: 3, reps: "6-10", rir: "RIR 2", rest: "2-3‚Äô", timer: 2.5 },
            { id: "hip_thrust_x", name: "Hip thrust barra", sets: 3, reps: "6-10", rir: "RIR 1-2", rest: "2‚Äô", timer: 2 },
            { id: "curl_femoral_x", name: "Curl femoral tumbado", sets: 3, reps: "8-12", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 },
            { id: "gemelos_pie_x", name: "Gemelos de pie", sets: 3, reps: "8-12", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5 }
        ]
      },
      {
        title: "Jueves ‚Ä¢ Push (Delts)",
        exercises: [
            { id: "militar_manc", name: "Press militar sentado mancuernas", sets: 3, reps: "6-10", rir: "RIR 2", rest: "2‚Äô", timer: 2 },
            { id: "press_cerrado_smith", name: "Press banca agarre cerrado Smith", sets: 2, reps: "8-12", rir: "RIR 1-2", rest: "2‚Äô", timer: 2 },
            { id: "laterales_j", name: "Elevaci√≥n lateral", sets: 2, reps: "12-20", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5 },
            { id: "peck_deck", name: "Peck-deck", sets: 2, reps: "10-15", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 },
            { id: "triceps_ez", name: "Extensi√≥n tr√≠ceps barra EZ", sets: 2, reps: "10-12", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5 },
            { id: "gemelos_sentado_j", name: "Gemelos sentado", sets: 3, reps: "12-20", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5 }
        ]
      },
      {
        title: "Viernes ‚Ä¢ Pull (Espesor)",
        exercises: [
            { id: "remo_t", name: "Remo T apoyado pecho", sets: 4, reps: "6-10", rir: "RIR 1-2", rest: "2-3‚Äô", timer: 2.5 },
            { id: "remo_cable_neutro", name: "Remo cable neutro", sets: 3, reps: "8-12", rir: "RIR 1-2", rest: "2‚Äô", timer: 2 },
            { id: "reverse_fly", name: "Reverse fly", sets: 2, reps: "15-20", rir: "RIR 0-1", rest: "60-90‚Äù", timer: 1.5 },
            { id: "curl_martillo", name: "Curl martillo", sets: 2, reps: "8-12", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 },
            { id: "curl_inclinado", name: "Curl inclinado (estirado)", sets: 2, reps: "10-15", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 }
        ]
      },
      {
        title: "S√°bado ‚Ä¢ Pierna (Full)",
        exercises: [
            { id: "hack_squat", name: "Hack squat / Pendulum", sets: 4, reps: "8-12", rir: "RIR 1-2", rest: "2-3‚Äô", timer: 2.5, note: "ROM C√≥modo. Si duele: step-up bajo o belt squat." },
            { id: "prensa_pies_bajos", name: "Prensa 45¬∞ pies bajos", sets: 3, reps: "10-15", rir: "RIR 1-2", rest: "2-3‚Äô", timer: 2.5, note: "Hacer si se tolera (m√°s quad)." },
            { id: "extension_1.5", name: "Extensi√≥n 1.5 reps", sets: 3, reps: "12-15", rir: "RIR 1", rest: "90‚Äù", timer: 1.5, note: "Recorrido: mitad ‚Üí completo ‚Üí mitad." },
            { id: "curl_femoral_sentado", name: "Curl femoral sentado", sets: 3, reps: "10-15", rir: "RIR 1", rest: "90‚Äù", timer: 1.5 },
            { id: "gemelos_pie_s", name: "Gemelos de pie", sets: 4, reps: "8-12", rir: "RIR 1", rest: "60-90‚Äù", timer: 1.5 }
        ]
      },
      {
        title: "Domingo ‚Ä¢ Descanso",
        exercises: [
            { id: "descanso", name: "Descanso Activo", note: "Paseo ligero, movilidad suave. El objetivo es recuperar bien para la pr√≥xima semana." }
        ]
      }
    ]
  };

  const $ = (q, el = document) => el.querySelector(q);
  const $$ = (q, el = document) => [...el.querySelectorAll(q)];
  const stateKey = 'rutina-fuerza-elegante-v7-final';
  let state = JSON.parse(localStorage.getItem(stateKey) || '{}');
  const originalTitle = document.title;
  const today = new Date();
  const dow = (today.getDay() + 6) % 7;
  const tabsContainer = $('#tabs');
  const workoutsContainer = $('#workouts');
  const weekSel = $('#week');
  const weekHint = $('#weekHint');
  const notes = $('#notes');
  const header = $('header');
  const headerTitle = $('#header-title');
  const headerSubtitle = $('#header-subtitle');
  const headerTabs = $('#header-tabs');
  const headerActions = $('#header-actions');
  let routineData;
  const timers = new Map();
  let activeTimerId = null;

  function renderRoutine(data) {
    tabsContainer.innerHTML = '';
    workoutsContainer.innerHTML = '';

    data.days.forEach((day, dayIndex) => {
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.dataset.day = dayIndex;
      tab.innerHTML = `<span>${day.title}</span><div class="progress-bar"></div>`;
      tabsContainer.appendChild(tab);

      const dayCard = document.createElement('article');
      dayCard.className = 'card day';
      dayCard.dataset.day = dayIndex;
      dayCard.style.animationDelay = `${0.1 + dayIndex * 0.05}s`;
      let exercisesHTML = `<h2>${day.title.replace(/‚Ä¢/g, '‚Äì')}</h2>`;

      day.exercises.forEach(ex => {
        const exId = `${dayIndex}:${ex.id}`;
        if (!ex.sets) {
            exercisesHTML += `<div class="exercise" data-ex-id="${exId}"><div class="head"><div class="name">${ex.name}</div></div>${ex.note ? `<p class="exercise-note" style="margin-top:0;">${ex.note}</p>` : ''}</div>`;
            return;
        }

        exercisesHTML += `
          <div class="exercise" data-ex-id="${exId}" data-ex-name="${ex.name}">
            <div class="head">
                <div class="name">${ex.name}</div>
                <div class="meta">
                    <span class="pill p-rep">${ex.sets}√ó${ex.reps}</span>
                    <span class="pill p-rir">${ex.rir}</span>
                    <span class="pill p-rest">${ex.rest}</span>
                </div>
            </div>
            <div class="sets" data-default="${ex.sets}"></div>
            ${ex.note ? `<p class="exercise-note">${ex.note}</p>` : ''}
            <div class="row">
                <div class="timer" data-min="${ex.timer || 1.5}"><b>00:00</b><button class="btn btn-mini" data-action="toggle-timer">‚ñ∂Ô∏é</button></div> 
                <button class="btn" data-action="add-set">+ Serie</button> 
                <button class="btn delset" data-action="del-set">‚Äì Serie</button>
            </div>
          </div>`;
      });
      dayCard.innerHTML = exercisesHTML;
      workoutsContainer.appendChild(dayCard);
    });
  }
  
  function initializeTimers() {
      timers.clear();
      $$('.timer').forEach(timerEl => {
          const exId = timerEl.closest('.exercise').dataset.exId;
          const min = parseFloat(timerEl.dataset.min || '2');
          const display = $('b', timerEl);
          const btn = $('button', timerEl);
          let running = false, left = 0, iv = null;

          const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;
          const start = () => { 
              if (running) return;
              if (activeTimerId && activeTimerId !== exId) {
                  timers.get(activeTimerId)?.stop();
              }
              activeTimerId = exId;
              left = Math.round(min * 60); 
              running = true; 
              btn.textContent = '‚è∏'; 
              timerEl.classList.add('running'); 
              tick(); 
              iv = setInterval(tick, 1000); 
          };
          const stop = () => { 
              running = false; 
              clearInterval(iv); 
              btn.textContent = '‚ñ∂Ô∏é'; 
              timerEl.classList.remove('running'); 
              document.title = originalTitle; 
              display.textContent = fmt(min * 60);
              if (activeTimerId === exId) {
                  activeTimerId = null;
              }
          };
          const tick = () => { display.textContent = fmt(left); document.title = `${fmt(left)} | Descanso`; if (left-- <= 0) stop(); };
          
          display.textContent = fmt(min * 60);
          timers.set(exId, { start, stop, isRunning: () => running });
      });
  }
  
  function renderSets(setsWrap, arr, id) {
    setsWrap.innerHTML = '';
    arr.forEach((val, i) => {
        const b = document.createElement('button');
        b.className = 'set' + (val ? ' done' : '');
        b.dataset.action = 'toggle-set';
        b.dataset.index = i;
        b.innerHTML = `S${i+1}<small>${val?'OK':'-'}</small>`;
        setsWrap.appendChild(b);
    });
    updateAllProgressBars();
  }

  function handleWorkoutClick(event) {
    const target = event.target;
    const action = target.dataset.action || target.closest('[data-action]')?.dataset.action;
    if (!action) return;

    const exerciseEl = target.closest('.exercise');
    if (!exerciseEl) return;
    const exId = exerciseEl.dataset.exId;
    const exName = exerciseEl.dataset.exName;
    const setsWrap = $('.sets', exerciseEl);

    switch (action) {
        case 'toggle-set': {
            const setIndex = parseInt(target.dataset.index, 10);
            const now = state.sets[exId];
            const isCompletingSet = !now[setIndex];
            now[setIndex] = isCompletingSet;
            
            saveSets(exId, now);
            renderSets(setsWrap, now, exId);
            
            if (isCompletingSet) {
                const button = $(`.set[data-index='${setIndex}']`, setsWrap);
                button.classList.add('pop-animation');
                button.addEventListener('animationend', () => button.classList.remove('pop-animation'), { once: true });
                timers.get(exId)?.start();

                const allSetsDone = now.every(s => s === true);
                if (allSetsDone) {
                    showWeightModal(exId, exName);
                }
            }
            break;
        }
        case 'toggle-timer': {
            const timer = timers.get(exId);
            if (timer) timer.isRunning() ? timer.stop() : timer.start();
            break;
        }
        case 'add-set': {
            const now = state.sets[exId];
            now.push(false);
            saveSets(exId, now);
            renderSets(setsWrap, now, exId);
            break;
        }
        case 'del-set': {
            const now = state.sets[exId];
            if (now.length > 1) {
                now.pop();
                saveSets(exId, now);
                renderSets(setsWrap, now, exId);
            }
            break;
        }
    }
  }
  
  function saveSets(id, arr) {
    state.sets[id] = arr;
    save();
    const delBtn = $(`[data-ex-id="${id}"] [data-action="del-set"]`);
    if(delBtn) delBtn.classList.toggle('ghost', arr.length <= 1);
  }

  function activateTab(idx) {
    $$('.tab', tabsContainer).forEach(t => t.classList.remove('active'));
    $(`.tab[data-day="${idx}"]`, tabsContainer)?.classList.add('active');
    $$('.day').forEach(c => c.style.display = (+c.dataset.day === idx) ? 'block' : 'none');
    state.lastOpenedDay = idx;
    save();
  }
  
  function switchPage(pageId) {
    $$('.app-page').forEach(p => p.classList.remove('active'));
    $(`#${pageId}`)?.classList.add('active');
    $$('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
    
    if (pageId === 'progress-page') {
        headerTitle.textContent = "Progreso";
        headerSubtitle.style.display = 'none';
        headerTabs.style.display = 'none';
        headerActions.style.display = 'none';
        renderProgressPage();
    } else {
        headerTitle.textContent = "Rutina Personalizada";
        headerSubtitle.style.display = 'block';
        headerTabs.style.display = 'block';
        headerActions.style.display = 'block';
    }
  }

  function renderProgressPage() {
      const contentEl = $('#progress-content');
      state.progress = state.progress || {};
      const exercisesWithProgress = Object.keys(state.progress).filter(key => state.progress[key].length > 0);

      if (exercisesWithProgress.length === 0) {
          contentEl.innerHTML = `<div id="no-progress-data">A√∫n no has registrado ning√∫n progreso. ¬°Completa un ejercicio para empezar!</div>`;
          return;
      }

      let listHTML = '<div class="progress-list">';
      exercisesWithProgress.forEach(exId => {
          const exName = state.progress[exId][0].name; // Get name from first record
          listHTML += `<div class="exercise-item" data-ex-id="${exId}">${exName}</div>`;
      });
      listHTML += '</div>';
      contentEl.innerHTML = listHTML;
  }

  function renderProgressDetail(exId) {
      const records = state.progress[exId];
      if (!records || records.length === 0) return;
      
      const contentEl = $('#progress-content');
      const exName = records[0].name;

      let tableHTML = `
        <div id="progress-detail-view">
            <button class="btn" id="back-to-progress-list" style="margin-bottom: 1rem;">‚Üê Volver</button>
            <h3>${exName}</h3>
            <div class="progress-chart-container card"><svg id="chart-svg" viewBox="0 0 300 150"></svg></div>
            <table id="progress-history-table">
                <thead><tr><th>Fecha</th><th>Peso (kg)</th></tr></thead>
                <tbody>`;
      [...records].reverse().forEach(r => {
          tableHTML += `<tr><td>${r.date}</td><td>${r.weight}</td></tr>`;
      });
      tableHTML += `</tbody></table></div>`;
      contentEl.innerHTML = tableHTML;
      
      renderChart(records);
  }

  function renderChart(records) {
      const svg = $('#chart-svg');
      if (!svg) return;
      
      const data = records.slice(-10);
      const weights = data.map(d => d.weight);
      const minWeight = Math.min(...weights);
      const maxWeight = Math.max(...weights);
      let weightRange = maxWeight - minWeight;
      
      const width = 300;
      const height = 150;
      const padding = { top: 20, right: 15, bottom: 30, left: 35 };

      if (weightRange === 0) {
          weightRange = maxWeight * 0.2 || 10; // 20% del peso o 10kg como rango
      }
      const yMin = Math.max(0, minWeight - weightRange * 0.1);
      const yMax = maxWeight + weightRange * 0.1;
      const finalRange = yMax - yMin;

      const getX = (index) => padding.left + (index * (width - padding.left - padding.right) / (data.length - 1 || 1));
      const getY = (weight) => (height - padding.bottom) - ((weight - yMin) / (finalRange || 1)) * (height - padding.top - padding.bottom);
      
      let points = data.map((d, i) => `${getX(i)},${getY(d.weight)}`).join(' ');
      
      let svgContent = `
          <line class="grid-line" x1="${padding.left}" y1="${padding.top}" x2="${width - padding.right}" y2="${padding.top}"></line>
          <line class="grid-line" x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}"></line>
          <text class="axis-label-y" x="${padding.left - 5}" y="${padding.top}" dominant-baseline="middle" text-anchor="end">${Math.round(yMax)}kg</text>
          <text class="axis-label-y" x="${padding.left - 5}" y="${height - padding.bottom}" dominant-baseline="middle" text-anchor="end">${Math.round(yMin)}kg</text>
      `;
      if(data.length > 1) {
          svgContent += `<polyline class="data-line" points="${points}"></polyline>`;
      }
      data.forEach((d, i) => {
          const x = getX(i);
          const y = getY(d.weight);
          const shortDate = d.date.substring(0, 5); // DD/MM
          svgContent += `
            <circle class="data-point" cx="${x}" cy="${y}"><title>${d.date}: ${d.weight}kg</title></circle>
            <text class="data-label" x="${x}" y="${y - 8}" text-anchor="middle">${d.weight}</text>
            <text class="axis-label-x" x="${x}" y="${height - padding.bottom + 15}" text-anchor="middle">${shortDate}</text>
          `;
      });
      
      svg.innerHTML = svgContent;
  }
  
  function showWeightModal(exId, exName) {
      const overlay = $('#modal-overlay');
      $('#modal-title').textContent = `Registrar carga para ${exName}`;
      const weightInput = $('#modal-weight-input');
      weightInput.value = '';
      
      const lastRecord = state.progress?.[exId]?.slice(-1)[0];
      if (lastRecord) {
          weightInput.placeholder = `√öltimo peso: ${lastRecord.weight}kg`;
      } else {
          weightInput.placeholder = 'Peso (kg)';
      }

      overlay.classList.add('visible');
      weightInput.focus();

      const saveHandler = () => {
          const weight = parseFloat(weightInput.value);
          if (weight && weight > 0) {
              state.progress = state.progress || {};
              state.progress[exId] = state.progress[exId] || [];
              state.progress[exId].push({
                  name: exName,
                  date: getFormattedDate(),
                  weight: weight
              });
              save();
              showNotification('Progreso guardado.');
          }
          closeModal();
      };

      const cancelHandler = () => closeModal();
      const keyHandler = (e) => { if(e.key === 'Enter') saveHandler(); };

      $('#modal-save').onclick = saveHandler;
      $('#modal-cancel').onclick = cancelHandler;
      weightInput.onkeydown = keyHandler;
      
      function closeModal() {
          overlay.classList.remove('visible');
          $('#modal-save').onclick = null;
          $('#modal-cancel').onclick = null;
          weightInput.onkeydown = null;
      }
  }

  function currentDay() { 
      const t = $('.tab.active', tabsContainer); 
      return t ? +t.dataset.day : 0; 
  }

  function resetCurrentDay(){
    const d = currentDay();
    const card = $(`.day[data-day="${d}"]`);
    if (card) {
      $$('.exercise', card).forEach(ex=>{
        const setsWrap = $('.sets',ex);
        if (!setsWrap) return;
        const exId = ex.dataset.exId;
        const def = +setsWrap.dataset.default || 0;
        const arr = Array(def).fill(false);
        saveSets(exId, arr);  
        renderSets(setsWrap, arr, exId);
      });
    }
  }

  function updateAllProgressBars() {
    if (!routineData) return;
    routineData.days.forEach((day, dayIndex) => {
        const tab = $(`.tab[data-day="${dayIndex}"]`);
        if (!tab) return;
        let totalSets = 0, doneSets = 0;
        day.exercises.forEach(ex => {
            if (ex.sets) {
                const exId = `${dayIndex}:${ex.id}`;
                const setsArray = state.sets?.[exId];
                if (setsArray) {
                    totalSets += setsArray.length;
                    doneSets += setsArray.filter(d => d).length;
                } else {
                    totalSets += (ex.sets || 0);
                }
            }
        });
        const percentage = totalSets > 0 ? (doneSets / totalSets) * 100 : 0;
        const progressBar = $('.progress-bar', tab);
        if (progressBar) progressBar.style.width = `${percentage}%`;
    });
  }

  function init() {
    routineData = loadRoutineData();
    renderRoutine(routineData);
    
    state.sets = state.sets || {};
    routineData.days.forEach((day, dayIndex) => {
        day.exercises.forEach(ex => {
            if (ex.sets) {
                const exId = `${dayIndex}:${ex.id}`;
                if (!state.sets[exId]) {
                   state.sets[exId] = Array(ex.sets).fill(false);
                }
                const setsWrap = $(`[data-ex-id="${exId}"] .sets`);
                if(setsWrap) renderSets(setsWrap, state.sets[exId], exId);
            }
        });
    });
    
    initializeTimers();
    workoutsContainer.addEventListener('click', handleWorkoutClick);
    tabsContainer.addEventListener('click', e => {
        const tab = e.target.closest('.tab');
        if (tab) activateTab(+tab.dataset.day);
    });
    
    $('#bottom-nav').addEventListener('click', e => {
        const navBtn = e.target.closest('.nav-btn');
        if (navBtn) switchPage(navBtn.dataset.page);
    });

    $('.title').addEventListener('click', () => switchPage('routine-page'));
    
    $('#progress-content').addEventListener('click', e => {
        const item = e.target.closest('.exercise-item');
        if (item) {
            renderProgressDetail(item.dataset.exId);
        } else if (e.target.id === 'back-to-progress-list') {
            renderProgressPage();
        }
    });

    $('#resetDay').addEventListener('click', resetCurrentDay);
    $('#progressBtnDesktop').addEventListener('click', () => switchPage('progress-page'));
    
    if (state.week) weekSel.value = state.week;
    applyWeekHint();
    notes.value = state.notes || '';
    notes.addEventListener('change', () => { state.notes = notes.value; save(); }); // Optimizado a 'change'

    const initialDay = state.lastOpenedDay !== undefined ? state.lastOpenedDay : dow;
    activateTab(initialDay);
    updateAllProgressBars();
    
    window.addEventListener('scroll', () => {
        header.classList.toggle('scrolled', window.scrollY > 10);
    });
  }
  
  // --- HELPERS ---
  const getFormattedDate = () => {
      const d = new Date();
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
  };

  function loadRoutineData() {
      const savedRoutine = localStorage.getItem('customRoutineData');
      if (savedRoutine) {
          try { 
              const parsed = JSON.parse(savedRoutine);
              if (!parsed.days) throw new Error("Invalid routine format");
              return parsed;
          } 
          catch (e) { 
              console.error("Error al cargar rutina guardada, usando la de por defecto.", e); 
              return defaultRoutineData; 
          }
      }
      return defaultRoutineData;
  }
  
  function save() { 
      try {
          localStorage.setItem(stateKey, JSON.stringify(state)); 
      } catch (e) {
          console.error("Error al guardar el estado:", e);
          showNotification("No se pudo guardar el progreso.", "error");
      }
  }
  
  let notificationTimeout;
  function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      if (!notification) return;
      clearTimeout(notificationTimeout);
      const icon = type === 'success' ? '‚úÖ' : '‚ùå';
      notification.innerHTML = `<span style="margin-right: 0.5rem;">${icon}</span> ${message}`;
      notification.className = type;
      setTimeout(() => { notification.classList.add('show'); }, 10);
      notificationTimeout = setTimeout(() => { notification.classList.remove('show'); }, 3000);
  }

  function applyWeekHint() {
    const w = weekSel.value; weekHint.style.color = 'var(--muted)'; weekHint.textContent = '';
    if(w === '1'){ weekHint.textContent='Sem 1: Compuestos @RIR2‚Äì3; Accesorios @RIR1‚Äì2.'; } 
    else if(w === '2' || w === '3'){ weekHint.textContent='Sem 2‚Äì3: Compuestos @RIR1‚Äì2; Accesorios @RIR0‚Äì1.'; weekHint.style.color='var(--warn)'; } 
    else if(w === '4'){ weekHint.textContent='DELOAD: ‚àí40‚Äì50% series, +1‚Äì2 RIR.'; weekHint.style.color='var(--danger)'; } 
    else if(w === '5' || w === '6'){ weekHint.textContent='Sem 5‚Äì6: Repite Sem 2-3 y a√±ade +1 serie a quads o lats.'; weekHint.style.color='var(--ok)'; }
  }

  function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
          try {
              const importedData = JSON.parse(e.target.result);
              if (!importedData.days || !Array.isArray(importedData.days)) { throw new Error("Formato de rutina inv√°lido."); }
              
              localStorage.setItem('customRoutineData', JSON.stringify(importedData));
              // Limpieza completa del estado de la app para evitar conflictos con la nueva rutina
              localStorage.removeItem(stateKey); 
              state = {}; 
              
              init();
              showNotification('Rutina importada con √©xito.');
          } catch (error) {
              console.error("Fallo al importar la rutina:", error);
              showNotification('Error: El archivo JSON no es v√°lido.', 'error');
          }
      };
      reader.readAsText(file);
      event.target.value = '';
  }

  function handleExport() {
      try {
          const jsonString = JSON.stringify(routineData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'mi-rutina.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showNotification('Rutina exportada.');
      } catch (error) {
          console.error("Fallo al exportar la rutina:", error);
          showNotification('Error al exportar.', 'error');
      }
  }

  $('#importBtn').addEventListener('click', () => $('#importFile').click());
  $('#importFile').addEventListener('change', handleImport);
  $('#exportBtn').addEventListener('click', handleExport);

  init();
  
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker: Registrado'))
        .catch(err => console.log(`Service Worker: Error: ${err}`));
    });
  }
})();
</script>
</body>
</html>

